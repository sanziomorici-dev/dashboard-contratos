<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercial - Onfly California</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        onfly: {
                            blue: '#0097FF',
                            dark: '#092C4C',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Toast notification */
        #toast {
            position: fixed; bottom: 24px; right: 24px; z-index: 999;
            background: #092C4C; color: white; padding: 14px 20px;
            border-radius: 12px; font-size: 14px; font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            transform: translateY(80px); opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { transform: translateY(0); opacity: 1; }
        #toast.success { border-left: 4px solid #22c55e; }
        #toast.error   { border-left: 4px solid #ef4444; }

        /* Import button pulse */
        @keyframes pulse-ring {
            0%   { box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
            70%  { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
            100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
        }
        .btn-import { animation: pulse-ring 2.5s infinite; }

        /* Skeleton loading */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; border-radius: 6px; }
        @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Toast Notification -->
    <div id="toast">
        <svg id="toast-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
        <span id="toast-msg">Mensagem</span>
    </div>

    <!-- Navbar / Header -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm sticky top-0 z-20">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-3 w-1/4">
                <img src="./Onfly_Logo.jpg" alt="Logo Onfly" class="h-12 object-contain"
                     onerror="this.outerHTML='<div class=\'text-2xl font-extrabold text-onfly-dark\'>onfly</div>'">
            </div>
            <div class="hidden sm:flex flex-col flex-1 justify-center items-center mt-1">
                <h1 class="text-xl sm:text-2xl lg:text-3xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-onfly-dark to-onfly-blue drop-shadow-sm uppercase text-center leading-none">
                    Contracts - Feb/26
                </h1>
                <p class="text-gray-400 font-semibold text-sm lg:text-base tracking-widest uppercase mt-1">InteligÃªncia Comercial</p>
            </div>
            <div class="w-1/4 text-right hidden sm:flex justify-end">
                <div class="border-2 border-green-200 bg-green-50 px-4 py-2.5 rounded-xl shadow-sm inline-block">
                    <p class="text-sm font-semibold text-gray-700">MÃ©dia GMV: <span class="text-green-700 font-extrabold text-base" id="header-avg-gmv">R$ 0</span></p>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">

        <!-- â”€â”€ SEÃ‡ÃƒO DE FILTROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 items-end">

                <!-- Filtro Squad -->
                <div class="w-full sm:w-1/4">
                    <label for="squadFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Squad</label>
                    <select id="squadFilter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-onfly-blue focus:ring-onfly-blue p-2.5 bg-gray-50 border text-sm">
                        <option value="all">Todos os Squads</option>
                    </select>
                </div>

                <!-- Filtro Closer -->
                <div class="w-full sm:w-1/4">
                    <label for="closerFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Closer</label>
                    <select id="closerFilter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-onfly-blue focus:ring-onfly-blue p-2.5 bg-gray-50 border text-sm">
                        <option value="all">Todos os Closers</option>
                    </select>
                </div>

                <!-- Filtro Status -->
                <div class="w-full sm:w-1/4">
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status</label>
                    <select id="statusFilter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-onfly-blue focus:ring-onfly-blue p-2.5 bg-gray-50 border text-sm">
                        <option value="all">Todos os Status</option>
                        <option value="signed">âœ… Assinados (OK)</option>
                        <option value="pending">â³ Pendentes</option>
                    </select>
                </div>

                <!-- BotÃµes de aÃ§Ã£o -->
                <div class="w-full sm:w-1/4 flex flex-col sm:flex-row gap-2 justify-end">
                    <button onclick="resetFilters()"
                        class="px-3 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Limpar
                    </button>

                    <!-- INPUT oculto para seleÃ§Ã£o de arquivo -->
                    <input type="file" id="excelUpload" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(event)">

                    <!-- BOTÃƒO IMPORTAR (principal) -->
                    <button onclick="document.getElementById('excelUpload').click()"
                        class="btn-import px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-bold flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        IMPORTAR
                    </button>

                    <!-- BOTÃƒO EXPORTAR CSV -->
                    <button onclick="exportToCSV()"
                        class="px-3 py-2.5 bg-onfly-blue text-white rounded-lg hover:bg-blue-400 transition-colors text-sm font-medium flex items-center justify-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Exportar
                    </button>
                </div>
            </div>

            <!-- Indicador de Ãºltima importaÃ§Ã£o -->
            <div id="import-info" class="mt-3 text-xs text-gray-400 hidden flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span id="import-info-text"></span>
            </div>
        </section>

        <!-- â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <div class="bg-white p-4 xl:p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-onfly-blue">
                <p class="text-xs xl:text-sm font-medium text-gray-500 truncate">Valor Potencial</p>
                <h3 class="text-lg xl:text-xl 2xl:text-2xl font-bold text-blue-700 mt-1 tracking-tight truncate" id="kpi-potential">R$ 0</h3>
                <p class="text-[11px] xl:text-xs text-gray-400 mt-1 truncate" id="kpi-qtd-potential">0 mapeados</p>
            </div>
            <div class="bg-white p-4 xl:p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-green-500">
                <p class="text-xs xl:text-sm font-medium text-gray-500 truncate">Valor Assinado</p>
                <h3 class="text-lg xl:text-xl 2xl:text-2xl font-bold text-green-600 mt-1 tracking-tight truncate" id="kpi-signed">R$ 0</h3>
                <p class="text-[11px] xl:text-xs text-gray-400 mt-1 truncate" id="kpi-qtd-signed">0 fechados</p>
            </div>
            <div class="bg-white p-4 xl:p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-onfly-dark">
                <p class="text-xs xl:text-sm font-medium text-gray-500 truncate">ConversÃ£o (R$)</p>
                <h3 class="text-lg xl:text-xl 2xl:text-2xl font-bold text-blue-700 mt-1 tracking-tight truncate" id="kpi-conversion">0%</h3>
                <p class="text-[11px] xl:text-xs text-gray-400 mt-1 truncate">Assinado / Potencial</p>
            </div>
            <div class="bg-white p-4 xl:p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-gray-400">
                <p class="text-xs xl:text-sm font-medium text-gray-500 truncate">Ticket MÃ©dio</p>
                <h3 class="text-lg xl:text-xl 2xl:text-2xl font-bold text-blue-700 mt-1 tracking-tight truncate" id="kpi-ticket">R$ 0</h3>
                <p class="text-[11px] xl:text-xs text-gray-400 mt-1 truncate">Somente 'OK'</p>
            </div>
            <div class="bg-white p-4 xl:p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-purple-500">
                <p class="text-xs xl:text-sm font-medium text-gray-500 truncate">ConversÃ£o (Qtd)</p>
                <h3 class="text-lg xl:text-xl 2xl:text-2xl font-bold text-blue-700 mt-1 tracking-tight truncate" id="kpi-conversion-qtd">0%</h3>
                <p class="text-[11px] xl:text-xs text-gray-400 mt-1 truncate">Assinados / Mapeados</p>
            </div>
        </section>

        <!-- â”€â”€ BANNER CAMPANHA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="w-full bg-gradient-to-r from-onfly-dark to-onfly-blue rounded-xl shadow-md py-3 px-6 lg:px-8 mb-8 flex flex-col md:flex-row items-center justify-between text-white relative overflow-hidden border border-onfly-blue/20">
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            <div class="absolute left-20 -bottom-20 w-32 h-32 bg-blue-300 opacity-20 rounded-full blur-2xl"></div>

            <div class="z-10 flex items-center gap-3 mb-3 md:mb-0">
                <div class="bg-white/20 p-2.5 rounded-full shadow-inner">
                    <svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg lg:text-xl font-bold tracking-tight">Campanha de Incentivo: ConcorrÃªncia</h2>
                    <p class="text-blue-100 text-xs mt-0.5">Contratos mapeados com Paytrack (PTR) e Voll (VLL)</p>
                </div>
            </div>

            <div class="z-10 flex gap-4 sm:gap-6 bg-white/10 px-4 sm:px-6 py-2 rounded-lg border border-white/20 shadow-sm w-full md:w-auto justify-center items-stretch">
                <div class="text-center flex flex-col items-center w-[110px]">
                    <p class="text-3xl lg:text-4xl font-bold text-yellow-300 leading-none drop-shadow-md" id="kpi-ptr">0</p>
                    <p class="text-[10px] font-bold tracking-widest text-blue-100 mt-1 mb-1.5 uppercase leading-none">Paytrack</p>
                    <div id="kpi-ptr-squads" class="flex flex-wrap justify-center gap-1 mt-auto"></div>
                </div>
                <div class="w-px bg-white/30"></div>
                <div class="text-center flex flex-col items-center w-[110px]">
                    <p class="text-3xl lg:text-4xl font-bold text-yellow-300 leading-none drop-shadow-md" id="kpi-vll">0</p>
                    <p class="text-[10px] font-bold tracking-widest text-blue-100 mt-1 mb-1.5 uppercase leading-none">Voll</p>
                    <div id="kpi-vll-squads" class="flex flex-wrap justify-center gap-1 mt-auto"></div>
                </div>
            </div>
        </section>

        <!-- â”€â”€ GRÃFICOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                <h2 class="text-base sm:text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-onfly-dark to-gray-500 tracking-tight mb-4 text-center">Performance GMV (R$)</h2>
                <div class="relative h-64 w-full"><canvas id="barChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                <h2 class="text-base sm:text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-onfly-dark to-gray-500 tracking-tight mb-4 text-center">ConversÃ£o (Qtde)</h2>
                <div class="relative h-64 w-full"><canvas id="qtyBarChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-1">
                <h2 class="text-base sm:text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-onfly-dark to-gray-500 tracking-tight mb-4 text-center">Status Receita</h2>
                <div class="relative h-64 w-full flex justify-center"><canvas id="doughnutChart"></canvas></div>
            </div>
        </section>

        <!-- â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h2 class="text-base sm:text-lg font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-onfly-dark to-gray-500 tracking-tight">Detalhamento de Contratos</h2>
                <span class="text-xs font-medium bg-blue-50 text-onfly-blue border border-blue-100 py-1 px-2 rounded-full shadow-sm" id="table-count">0 registros</span>
            </div>
            <div class="overflow-x-auto table-container" style="max-height: 520px;">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-white sticky top-0 z-10 shadow-sm font-semibold">
                        <tr>
                            <th class="px-5 py-3 cursor-pointer hover:bg-gray-50" onclick="sortTable('squad')">Squad <span class="text-gray-400">â†•</span></th>
                            <th class="px-5 py-3 cursor-pointer hover:bg-gray-50" onclick="sortTable('client')">Cliente / Empresa <span class="text-gray-400">â†•</span></th>
                            <th class="px-5 py-3 cursor-pointer hover:bg-gray-50" onclick="sortTable('closer')">Closer <span class="text-gray-400">â†•</span></th>
                            <th class="px-5 py-3 text-right cursor-pointer hover:bg-gray-50" onclick="sortTable('value')">GMV (R$) <span class="text-gray-400">â†•</span></th>
                            <th class="px-5 py-3 text-center">Status</th>
                            <th class="px-5 py-3 text-center">Tags</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="px-6 py-3 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 text-center sm:text-left">
                <span class="font-bold text-onfly-blue text-sm">*</span>
                O GMV realizado destes contratos serÃ¡ dobrado devido Ã  campanha de incentivo da concorrÃªncia (Paytrack / Voll).
            </div>
        </section>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SCRIPTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DADOS INICIAIS â€” Aba FEV da planilha Acpto_Contratos_Fev.xlsx
       (atualizados pela Ãºltima vez manualmente; use IMPORTAR para refresh)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let rawData = [
        { squad: 'Golden Gate', client: 'Editora do Brasil',  closer: 'Viviane de Oliveira',  value: 300000, signed: true,  tag: '' },
        { squad: 'Golden Gate', client: 'Karcher',            closer: 'Viviane de Oliveira',  value: 500000, signed: false, tag: '' },
        { squad: 'Golden Gate', client: 'Ecorodovias',        closer: 'Gislainy Goretti',      value: 700000, signed: false, tag: '' },
        { squad: 'Golden Gate', client: 'NetGlobe',           closer: 'Michelle Martins',      value:  40000, signed: false, tag: '' },
        { squad: 'Golden Gate', client: 'M. Way',             closer: 'Viviane de Oliveira',  value: 130000, signed: true,  tag: '' },
        { squad: 'Golden Gate', client: 'Vammo',              closer: 'Michelle Martins',      value:  25000, signed: true,  tag: '' },
        { squad: 'Golden Gate', client: 'AgroQuima',          closer: 'Gislainy Goretti',      value:  30000, signed: true,  tag: '' },
        { squad: 'Golden Gate', client: 'Dynamic Air',        closer: 'Fernanda Andrade',      value:  50000, signed: true,  tag: '' },
        { squad: 'Thryve',      client: 'Programers',         closer: 'Fabiane Bastos',        value:  60000, signed: true,  tag: '' },
        { squad: 'Thryve',      client: 'Rede AmazÃ´nica',     closer: 'Fabiane Bastos',        value: 100000, signed: true,  tag: '' },
        { squad: 'Malibu',      client: 'Alianzo',            closer: 'Tainan',                value:  70000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Brasilata',          closer: 'Higor Brenner',         value:  60000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Ceemeesse',          closer: 'Manuela Aguiar',        value: 150000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Dynamox',            closer: 'Higor Brenner',         value:  30000, signed: true,  tag: 'PTR' },
        { squad: 'Malibu',      client: 'Gencau',             closer: 'Hellen Costa',          value:  30000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'LSQ',                closer: 'Henrique Diniz',        value:  15000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Icasa',              closer: 'Hellen Costa',          value:  15000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Oceana',             closer: 'Samantha Miranda',      value:  50000, signed: false, tag: '' },
        { squad: 'Malibu',      client: 'Deville Hoteis',     closer: 'Marcela Alana',         value:  30000, signed: true,  tag: '' },
        { squad: 'Los Angeles', client: 'All Energy',          closer: 'Louruama Souza',        value:  10000, signed: true,  tag: '' },
        { squad: 'Los Angeles', client: 'Egelte',              closer: 'Caroline Colombini',    value: 150000, signed: true,  tag: 'PTR' },
        { squad: 'Los Angeles', client: 'Quantum',             closer: 'Priciane Nobre',        value: 100000, signed: false, tag: 'VLL' },
        { squad: 'Los Angeles', client: 'ILD Brasil',          closer: 'Caroline Colombini',    value:  10000, signed: true,  tag: '' },
        { squad: 'Los Angeles', client: 'Fucape Pesq & Ens',   closer: 'Tairiny Castro',        value:  60000, signed: true,  tag: '' },
        { squad: 'Los Altos',   client: 'Ziv',                closer: 'Gabriela Maia',         value: 150000, signed: false, tag: '' },
        { squad: 'Los Altos',   client: "Doce D'ocÃª",         closer: 'Gabriela Maia',         value: 150000, signed: true,  tag: '' },
        { squad: 'Los Altos',   client: 'Diffucap',           closer: 'Vinicius Pujoni',       value:  80000, signed: true,  tag: 'PTR' },
        { squad: 'Los Altos',   client: 'EPM',                closer: 'JoÃ£o Lucas',            value: 300000, signed: true,  tag: 'PTR' },
        { squad: 'Los Altos',   client: 'Hyper Saude',        closer: 'Natalia Nunes',         value:  25000, signed: false, tag: '' },
        { squad: 'Los Altos',   client: 'Galaxy Maritima',    closer: 'Mariana Barbosa',       value: 500000, signed: false, tag: '' },
        { squad: 'Beverly Hills', client: 'CPAPS',            closer: 'Matheus Cruz',          value:  15000, signed: false, tag: '' },
        { squad: 'Beverly Hills', client: 'Smart Call PY',    closer: 'Iago de Souza',         value:  40000, signed: true,  tag: '' },
        { squad: 'Beverly Hills', client: 'Grupo Impper',     closer: 'Matheus Cruz',          value:  15000, signed: true,  tag: '' },
        { squad: 'Beverly Hills', client: 'Back 2 ProduÃ§Ãµes', closer: 'Larissa Santos',        value:  20000, signed: true,  tag: '' },
        { squad: 'Beverly Hills', client: 'Grape',            closer: 'Natanael Vieira',       value: 100000, signed: true,  tag: '' },
        { squad: 'Beverly Hills', client: 'Club Pro +',       closer: 'AndrÃ© Alvarenga',       value:  10000, signed: false, tag: '' },
        { squad: 'Beverly Hills', client: 'Madrona ADV',      closer: 'Sabrina Lopes',         value: 100000, signed: false, tag: '' },
        { squad: 'Beverly Hills', client: 'Globe Connect',    closer: 'Iago de Souza',         value:  10000, signed: true,  tag: '' },
        { squad: 'Beverly Hills', client: 'Trust It',         closer: 'Sabrina Lopes',         value:  10000, signed: false, tag: '' },
    ];

    /* â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const R = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    let barChartInst, qtyBarChartInst, doughnutChartInst;
    let currentFilteredData = [];
    let sortKey = 'value', sortAsc = false;

    const $ = id => document.getElementById(id);
    const squadFilter  = $('squadFilter');
    const closerFilter = $('closerFilter');
    const statusFilter = $('statusFilter');

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showToast(msg, type = 'success') {
        const t = $('toast'), icon = $('toast-icon'), m = $('toast-msg');
        t.className = '';
        t.classList.add('show', type);
        m.textContent = msg;
        const svgOk   = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
        const svgErr  = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
        icon.innerHTML = type === 'success' ? svgOk : svgErr;
        setTimeout(() => t.classList.remove('show'), 3500);
    }

    /* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function init() {
        populateFilters();
        updateDashboard();
        squadFilter.addEventListener('change', updateDashboard);
        closerFilter.addEventListener('change', updateDashboard);
        statusFilter.addEventListener('change', updateDashboard);
    }

    /* â”€â”€ FILTROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function populateFilters() {
        const cS = squadFilter.value, cC = closerFilter.value;
        squadFilter.innerHTML  = '<option value="all">Todos os Squads</option>';
        closerFilter.innerHTML = '<option value="all">Todos os Closers</option>';

        const squads  = [...new Set(rawData.map(i => i.squad))].filter(Boolean).sort();
        const closers = [...new Set(rawData.map(i => i.closer))].filter(c => c && c.length > 2 && !['Closer','NÃ£o Informado','Direto'].includes(c)).sort();

        squads.forEach(s  => { const o = new Option(s, s); if (s === cS) o.selected = true; squadFilter.appendChild(o); });
        closers.forEach(c => { const o = new Option(c, c); if (c === cC) o.selected = true; closerFilter.appendChild(o); });
    }

    function resetFilters() {
        squadFilter.value = 'all'; closerFilter.value = 'all'; statusFilter.value = 'all';
        updateDashboard();
    }

    /* â”€â”€ DASHBOARD UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function updateDashboard() {
        currentFilteredData = rawData.filter(item => {
            const mS = squadFilter.value  === 'all' || item.squad  === squadFilter.value;
            const mC = closerFilter.value === 'all' || item.closer === closerFilter.value;
            const mT = statusFilter.value === 'all'
                    || (statusFilter.value === 'signed'  &&  item.signed)
                    || (statusFilter.value === 'pending' && !item.signed);
            return mS && mC && mT;
        });
        renderKPIs(currentFilteredData);
        renderTable(currentFilteredData);
        renderCharts(currentFilteredData);
    }

    /* â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderKPIs(data) {
        let tPot = 0, tSig = 0, qPot = data.length, qSig = 0, qPTR = 0, qVLL = 0;
        const sPTR = new Set(), sVLL = new Set();

        data.forEach(i => {
            tPot += i.value;
            if (i.signed) { tSig += i.value; qSig++; }
            if (i.tag === 'PTR') { qPTR++; sPTR.add(i.squad); }
            if (i.tag === 'VLL') { qVLL++; sVLL.add(i.squad); }
        });

        const avg = qPot > 0 ? tPot / qPot : 0;
        $('header-avg-gmv').textContent = R.format(avg);
        $('kpi-potential').textContent  = R.format(tPot);
        $('kpi-qtd-potential').textContent = `${qPot} mapeados`;
        $('kpi-signed').textContent     = R.format(tSig);
        $('kpi-qtd-signed').textContent = `${qSig} fechados`;
        $('kpi-conversion').textContent = `${(tPot > 0 ? (tSig/tPot)*100 : 0).toFixed(1)}%`;
        $('kpi-conversion-qtd').textContent = `${(qPot > 0 ? (qSig/qPot)*100 : 0).toFixed(1)}%`;
        $('kpi-ticket').textContent     = R.format(qSig > 0 ? tSig/qSig : 0);
        $('kpi-ptr').textContent = qPTR;
        $('kpi-vll').textContent = qVLL;

        const bCls = "text-[9px] bg-white/20 text-white px-1.5 py-0.5 rounded font-medium border border-white/10 leading-none";
        $('kpi-ptr-squads').innerHTML = [...sPTR].sort().map(s => `<span class="${bCls}">${s}</span>`).join('');
        $('kpi-vll-squads').innerHTML = [...sVLL].sort().map(s => `<span class="${bCls}">${s}</span>`).join('');
    }

    /* â”€â”€ ORDENAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function sortTable(key) {
        if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
        renderTable(currentFilteredData);
    }

    /* â”€â”€ TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderTable(data) {
        const tbody = $('tableBody');
        tbody.innerHTML = '';
        $('table-count').textContent = `${data.length} registros`;

        const sorted = [...data].sort((a, b) => {
            let av = a[sortKey], bv = b[sortKey];
            if (typeof av === 'string') av = av.toLowerCase();
            if (typeof bv === 'string') bv = bv.toLowerCase();
            return sortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
        });

        const colors = ['#f4f9ff','#ebf4ff','#e0effe','#d6eaff','#cce4ff','#c2dfff','#b8d5ff'];
        const uSq = [...new Set(sorted.map(i => i.squad))];
        const sqMap = {}; uSq.forEach((s, i) => sqMap[s] = colors[i % colors.length]);

        sorted.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:brightness-95 transition-all';
            row.style.backgroundColor = sqMap[item.squad] || '#fff';

            const statusBadge = item.signed
                ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2.5 py-1 rounded border border-green-200">âœ… OK</span>`
                : `<span class="bg-gray-100 text-gray-500 text-xs font-medium px-2.5 py-1 rounded border border-gray-200">â³ Pendente</span>`;

            const tagBadge = item.tag
                ? `<span class="text-xs font-bold px-2 py-0.5 rounded ${item.tag === 'PTR' ? 'bg-blue-100 text-onfly-blue' : 'bg-orange-100 text-orange-600'}">${item.tag} â­</span>`
                : `<span class="text-gray-300 text-xs">â€”</span>`;

            const gmvDisplay = (item.tag === 'PTR' || item.tag === 'VLL')
                ? `${R.format(item.value)} <span class="text-onfly-blue font-bold ml-0.5">*</span>`
                : R.format(item.value);

            row.innerHTML = `
                <td class="px-5 py-3.5 font-semibold text-gray-900 whitespace-nowrap">${item.squad}</td>
                <td class="px-5 py-3.5 whitespace-nowrap">${item.client}</td>
                <td class="px-5 py-3.5 whitespace-nowrap text-gray-600">${item.closer}</td>
                <td class="px-5 py-3.5 text-right font-semibold text-gray-900 whitespace-nowrap">${gmvDisplay}</td>
                <td class="px-5 py-3.5 text-center">${statusBadge}</td>
                <td class="px-5 py-3.5 text-center">${tagBadge}</td>
            `;
            tbody.appendChild(row);
        });
    }

    /* â”€â”€ GRÃFICOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderCharts(data) {
        const sqMap = {};
        data.forEach(i => {
            if (!sqMap[i.squad]) sqMap[i.squad] = { p: 0, s: 0, cp: 0, cs: 0 };
            sqMap[i.squad].p += i.value; sqMap[i.squad].cp++;
            if (i.signed) { sqMap[i.squad].s += i.value; sqMap[i.squad].cs++; }
        });

        const labels = Object.keys(sqMap).sort();
        const pD = labels.map(l => sqMap[l].p), sD = labels.map(l => sqMap[l].s);
        const qpD = labels.map(l => sqMap[l].cp), qsD = labels.map(l => sqMap[l].cs);

        const pctPlugin = {
            id: 'pctPlugin',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((ds, i) => {
                    if (i !== 1) return;
                    chart.getDatasetMeta(i).data.forEach((bar, idx) => {
                        const sig = ds.data[idx], pot = chart.data.datasets[0].data[idx];
                        if (pot > 0 && sig > 0) {
                            ctx.save();
                            ctx.fillStyle = '#15803d'; ctx.font = 'bold 9px Inter'; ctx.textAlign = 'center';
                            ctx.fillText(Math.round((sig/pot)*100) + '%', bar.x, bar.y - 8);
                            ctx.restore();
                        }
                    });
                });
            }
        };

        const chartOpts = (extra = {}) => ({
            responsive: true, maintainAspectRatio: false,
            layout: { padding: { top: 28 } },
            plugins: { legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } } },
            ...extra
        });

        if (barChartInst) barChartInst.destroy();
        barChartInst = new Chart($('barChart'), {
            type: 'bar',
            data: { labels, datasets: [
                { label: 'Potencial', data: pD, backgroundColor: '#0097FF', borderRadius: 5 },
                { label: 'Fechado',   data: sD, backgroundColor: '#22c55e', borderRadius: 5 }
            ]},
            plugins: [pctPlugin],
            options: chartOpts({ scales: { y: { ticks: { callback: v => 'R$ ' + (v/1000) + 'k' } } } })
        });

        if (qtyBarChartInst) qtyBarChartInst.destroy();
        qtyBarChartInst = new Chart($('qtyBarChart'), {
            type: 'bar',
            data: { labels, datasets: [
                { label: 'Mapeados',  data: qpD, backgroundColor: '#0097FF', borderRadius: 5 },
                { label: 'Assinados', data: qsD, backgroundColor: '#22c55e', borderRadius: 5 }
            ]},
            plugins: [pctPlugin],
            options: chartOpts({ scales: { y: { ticks: { stepSize: 1 } } } })
        });

        if (doughnutChartInst) doughnutChartInst.destroy();
        const tS = sD.reduce((a,b) => a+b, 0), tP = pD.reduce((a,b) => a+b, 0);
        doughnutChartInst = new Chart($('doughnutChart'), {
            type: 'doughnut',
            data: { labels: ['Fechada','Pendente'], datasets: [{ data: [tS, Math.max(0, tP-tS)], backgroundColor: ['#22c55e','#e2e8f0'], borderWidth: 0 }] },
            plugins: [{
                beforeDraw(c) {
                    const ctx = c.ctx, a = c.chartArea; if (!a) return;
                    const fS = ((a.bottom-a.top)/140).toFixed(2);
                    ctx.font = `bold ${fS}em Inter`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#092C4C';
                    ctx.fillText(tP > 0 ? Math.round((tS/tP)*100)+'%' : '0%', a.left+(a.right-a.left)/2, a.top+(a.bottom-a.top)/2);
                }
            }],
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } } }
        });
    }

    /* â”€â”€ EXPORTAR CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function exportToCSV() {
        if (!currentFilteredData.length) return showToast('Nenhum dado para exportar.', 'error');
        const headers = 'Squad,Cliente,Closer,GMV,Status,Tags\n';
        const rows = currentFilteredData.map(i =>
            `"${i.squad}","${i.client}","${i.closer}",${i.value},"${i.signed?'OK':'Pendente'}","${i.tag}"`
        ).join('\n');
        const blob = new Blob(['\uFEFF' + headers + rows], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'Exportacao_Onfly_FEV.csv'; a.click();
        showToast('CSV exportado com sucesso!');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ğŸ”‘ MOTOR DE IMPORTAÃ‡ÃƒO â€” LÃª especificamente a aba "FEV"
       Estrutura da planilha:
         Col D (Ã­ndice 3) â†’ Nome da empresa OU marcador de squad (*Squad*)
         Col E (Ã­ndice 4) â†’ Closer
         Col F (Ã­ndice 5) â†’ GMV (valor numÃ©rico)
         Col G (Ã­ndice 6) â†’ Status (OK = assinado; vazio = pendente)
         Col H (Ã­ndice 7) â†’ Tag (PTR, VLL ou vazia)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Reseta o input para permitir reimportar o mesmo arquivo
        event.target.value = '';

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });

                /* 1. Localizar a aba FEV (case-insensitive) */
                const sheetName = wb.SheetNames.find(n => n.trim().toUpperCase() === 'FEV');
                if (!sheetName) {
                    showToast('Aba "FEV" nÃ£o encontrada na planilha!', 'error');
                    return;
                }

                /* 2. Converter para array de arrays (raw = true para preservar nÃºmeros) */
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {
                    header: 1, raw: true, defval: ''
                });

                /* 3. Parsear linha a linha */
                const data = [];
                let currentSquad = 'Sem Squad';

                rows.forEach(row => {
                    if (!row || !row.length) return;

                    // CÃ©lula D = Ã­ndice 3 (a planilha comeÃ§a em col B=1, mas sheet_to_json usa col A=0)
                    // A planilha tem dados em B-M, entÃ£o o Ã­ndice 0 = col A (vazia), 3 = col D
                    const colD = row[3] != null ? String(row[3]).trim() : '';
                    const colE = row[4] != null ? String(row[4]).trim() : '';
                    const colF = row[5]; // nÃºmero bruto
                    const colG = row[6] != null ? String(row[6]).trim().toUpperCase() : '';
                    const colH = row[7] != null ? String(row[7]).trim().toUpperCase() : '';

                    /* 3a. Marcador de Squad (ex: *Golden Gate*) */
                    if (colD.startsWith('*') && colD.endsWith('*')) {
                        currentSquad = colD.replace(/\*/g, '').trim();
                        return; // pula a linha de cabeÃ§alho de squad
                    }

                    /* 3b. Linha de cabeÃ§alho de coluna ou totalizador (ignora) */
                    if (colD === '' || colD === 'Squad' || colD === 'Closer' || colD === 'CONTRACTS - FEB/26') return;
                    if (typeof colF !== 'number' || colF <= 0) return; // sem GMV vÃ¡lido

                    /* 3c. Dados reais do contrato */
                    const tag = ['PTR', 'VLL'].includes(colH) ? colH : '';
                    data.push({
                        squad:  currentSquad,
                        client: colD.replace(/\s+/g, ' '), // remove espaÃ§os duplos
                        closer: colE || 'Direto',
                        value:  Math.round(colF),
                        signed: colG === 'OK',
                        tag
                    });
                });

                if (!data.length) {
                    showToast('Nenhum contrato encontrado na aba FEV!', 'error');
                    return;
                }

                /* 4. Atualiza dashboard */
                rawData = data;
                populateFilters();
                updateDashboard();

                /* 5. Feedback visual */
                const now = new Date().toLocaleString('pt-BR');
                $('import-info-text').textContent = `${data.length} contratos importados da aba FEV em ${now}`;
                $('import-info').classList.remove('hidden');
                $('import-info').classList.add('flex');
                showToast(`âœ… ${data.length} contratos importados da aba FEV!`);

            } catch (err) {
                console.error(err);
                showToast('Erro ao ler o arquivo. Verifique se Ã© um .xlsx vÃ¡lido.', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
